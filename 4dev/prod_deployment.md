# Инструкция по развертыванию на Production сервере

Этот документ описывает пошаговый процесс развертывания Telegram-бота на сервере под управлением Ubuntu 24.04 с использованием Docker.

## 1. Подготовка сервера

На основе предоставленной конфигурации, `git` и `docker.io` уже установлены в системе. Необходимо установить Docker Compose, который используется для управления мультиконтейнерными Docker-приложениями.

```bash
# Обновляем список пакетов
apt-get update

# Устанавливаем плагин Docker Compose
apt-get install docker-compose-plugin
```

После установки убедитесь, что команда `docker compose` работает:

```bash
docker compose version
```

## 2. Клонирование и настройка проекта

1.  **Клонируйте репозиторий** на сервер. Замените `<URL_ВАШЕГО_РЕПОЗИТОРИЯ>` на актуальный URL.

    ```bash
    git clone <URL_ВАШЕГО_РЕПОЗИТОРИЯ> portfolio-ai
    cd portfolio-ai
    ```

2.  **Создайте файл переменных окружения** из примера.

    ```bash
    cp .env.example .env
    ```

3.  **Отредактируйте файл `.env`**, указав ваши секретные ключи и настройки. Используйте любой удобный текстовый редактор, например, `nano`.

    ```bash
    nano .env
    ```

    Вам необходимо заполнить как минимум следующие переменные:
    *   `BOT_TOKEN`
    *   `OPENROUTER_API_KEY`
    *   `EMBEDDING_SERVICE_URL`

## 3. Создание `docker-compose.yml`

В корневой директории проекта (`portfolio-ai/`) необходимо создать файл `docker-compose.yml`. Этот файл определяет, как будет запускаться и управляться контейнер с приложением.

**Содержимое файла `docker-compose.yml`:**

```yaml
version: '3.8'

services:
  app:
    build: .
    container_name: portfolio-ai-bot
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - chroma_data:/app/db
      - ./chat_history.sqlite3:/app/chat_history.sqlite3

volumes:
  chroma_data:
```

**Пояснение конфигурации:**
*   `build: .`: Указывает Docker Compose собрать образ из `Dockerfile` в текущей директории.
*   `container_name`: Задает имя контейнеру для удобства управления.
*   `restart: unless-stopped`: Автоматически перезапускает контейнер при сбоях или после перезагрузки сервера, если он не был остановлен вручную.
*   `env_file: - .env`: Пробрасывает переменные из файла `.env` в контейнер.
*   `volumes`: Обеспечивают сохранение данных между перезапусками контейнера:
    *   `chroma_data:/app/db`: Создает именованный том `chroma_data` и монтирует его в папку `/app/db` внутри контейнера, где `ChromaDB` хранит векторную базу.
    *   `./chat_history.sqlite3:/app/chat_history.sqlite3`: Монтирует файл `chat_history.sqlite3` из текущей директории хоста в корень приложения внутри контейнера. Это сохранит историю диалогов.

## 4. Сборка и первый запуск

1.  **Соберите и запустите контейнер** в фоновом режиме (`-d`).

    ```bash
    docker compose up --build -d
    ```

2.  **Проверьте логи**, чтобы убедиться, что приложение запустилось без ошибок.

    ```bash
    docker compose logs -f
    ```
    Нажмите `Ctrl+C`, чтобы выйти из режима просмотра логов.

## 5. Инициализация базы знаний

Для того чтобы бот мог отвечать на вопросы, необходимо один раз запустить скрипт векторизации для наполнения базы `ChromaDB`.

Выполните следующую команду, чтобы запустить скрипт `vectorize.py` внутри уже работающего контейнера:

```bash
docker compose exec app python vectorize.py
```

После выполнения скрипта векторная база данных будет создана и сохранена в томе `chroma_data`. Бот готов к работе.

## 6. Управление приложением

*   **Просмотр логов в реальном времени:**
    ```bash
    docker compose logs -f
    ```

*   **Остановка приложения:**
    ```bash
    docker compose down
    ```

*   **Обновление приложения (после изменений в коде):**
    1.  Загрузите изменения из Git: `git pull`
    2.  Пересоберите образ и перезапустите контейнер:
        ```bash
        docker compose up --build -d
        ```