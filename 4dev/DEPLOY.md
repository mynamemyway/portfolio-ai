# Инструкции по развертыванию и обслуживанию

Этот документ содержит два независимых набора инструкций для обслуживания приложения на production-сервере.

- **Процесс A:** Обновление кода приложения (когда вы меняете `.py` файлы, `requirements.txt` и т.д.).
- **Процесс B:** Обновление контента базы знаний (когда вы меняете только `.md` файлы).

---

## Процесс A: Обновление кода приложения

Этот процесс используется для развертывания изменений в логике приложения, его зависимостях или конфигурации Docker.

**Ключевой принцип:** Изменения в коде требуют **пересборки Docker-образа**, чтобы они вступили в силу. Последовательность `down -> build -> up` является обязательной для предотвращения конфликтов и гонки за ресурсы.

### Последовательность действий на сервере

1.  **Подключитесь к вашему серверу по SSH:**
    ```bash
    ssh mynamemyway@91.206.14.93
    ```

2.  **Перейдите в директорию проекта:**
    ```bash
    cd ~/portfolio-ai
    ```

3.  **Загрузите последние изменения кода из GitHub:**
    ```bash
    git pull
    ```

4.  **Полностью остановите все работающие сервисы.**
    Это критически важный шаг для освобождения всех ресурсов (портов, томов, сетей) перед сборкой.
    ```bash
    docker-compose down
    ```

5.  **Принудительно пересоберите Docker-образ.**
    Эта команда только собирает новый образ с вашим обновленным кодом, но **не запускает** контейнер.
    ```bash
    docker-compose build
    ```

6.  **Запустите обновленный сервис в фоновом режиме.**
    Эта команда запустит новый контейнер на основе только что собранного образа.
    ```bash
    docker-compose up -d
    ```

---

## Процесс B: Обновление базы знаний (контента)

Этот процесс используется, когда вы хотите обновить документы (`.md` файлы), на которых обучается AI, **не изменяя код приложения**.

### Шаг 1: Загрузка файлов на сервер (выполняется на Mac)

Используйте `scp` для безопасного копирования локальных документов на сервер. Команда автоматически перезапишет существующие файлы.

```bash
scp /Users/aleksandrsamohvalov/Documents/GitHub/portfolio-ai/app/knowledge_base/* mynamemyway@91.206.14.93:~/portfolio-ai/app/knowledge_base/
```

### Шаг 2: Переиндексация на сервере (выполняется на сервере)

1.  **Подключитесь к серверу по SSH** и перейдите в директорию проекта `~/portfolio-ai`.

2.  **Полностью остановите все работающие сервисы**, чтобы освободить блокировку с директории `chroma_db`.
    ```bash
    docker-compose down
    ```

3. **Принудительно удалите старую векторную базу.** Этот шаг необходим для обеспечения чистой индексации и предотвращения ошибок.

```bash
sudo rm -rf ~/portfolio-ai/chroma_db
```

4.  **Запустите процесс переиндексации.** Скрипт `rag.py` **автоматически удалит старую векторную базу** и создаст новую на основе загруженных вами файлов.
    ```bash
    docker-compose run --rm bot python -m app.core.rag
    ```

5.  **Запустите бота с обновленной базой знаний.**
    ```bash
    docker-compose up -d
    ```