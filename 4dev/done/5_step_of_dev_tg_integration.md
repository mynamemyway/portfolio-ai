# Шаг 5: Интеграция с Telegram (aiogram)

**Цель:** Интегрировать созданную RAG-цепочку в Telegram-бота, обеспечив прием сообщений, генерацию ответов и сохранение истории диалога.

---

### 1. Модификация `main.py` для интеграции обработчиков

#### **1.1. Реализация и регистрация обработчиков**
*   **Цель:** Создать и настроить все обработчики сообщений, объединив их в едином роутере для полной интеграции RAG-цепочки.
*   **Файл:** `main.py`.
*   **Логика:**
    1.  **Импорт модулей:**
        *   Подключены все необходимые компоненты: `Router`, `F`, `CommandStart`, `Message` из `aiogram`; `HumanMessage`, `AIMessage` из `langchain_core`; `get_rag_chain` и `get_chat_memory` из внутренних модулей.

    2.  **Настройка маршрутизатора (Router):**
        *   Создан экземпляр `Router` для модульной организации обработчиков.
        *   В функции `main()` роутер подключен к диспетчеру (`dp.include_router(router)`), что активирует все зарегистрированные в нем обработчики.

    3.  **Реализация обработчика `/start`:**
        *   Создана асинхронная функция `handle_start`, декорированная `@router.message(CommandStart())`.
        *   Функция отправляет пользователю статичное приветственное сообщение, объясняющее роль бота.

    4.  **Реализация основного обработчика сообщений:**
        *   Создана асинхронная функция `handle_message`, декорированная `@router.message(F.text)`. Она срабатывает на все текстовые сообщения, не являющиеся командами.
        *   **Индикатор печати:** Перед основной логикой бот отправляет статус `action="typing"`, чтобы улучшить UX.
        *   **Управление сессией:** `session_id` формируется на основе `message.chat.id` для ведения уникальной истории диалога с каждым пользователем.
        *   **Вызов RAG-цепочки:** Вызывается `rag_chain.ainvoke()` с `session_id` и текстом вопроса. Цепочка загружает историю, извлекает контекст из базы знаний и генерирует ответ с помощью LLM.
        *   **Отправка ответа:** Сгенерированный `ai_response` отправляется пользователю.
        *   **Сохранение истории:** После отправки ответа вопрос пользователя (`HumanMessage`) и ответ AI (`AIMessage`) явно сохраняются в `SQLiteChatMessageHistory` через `memory.chat_memory.add_messages()`. Это обеспечивает персистентность диалога для будущих запросов.

---

**Итог:** После выполнения всех пунктов этого плана файл `main.py` будет содержать полностью функционирующую логику Telegram-бота, способного вести осмысленный диалог на основе базы знаний и поддерживать контекст беседы с каждым пользователем индивидуально.