# План разработки: Интерактивное меню и приветствие с фото

## Введение
Цель этого плана — декомпозировать задачу по добавлению интерактивного меню и фото в приветственное сообщение на последовательные, атомарные шаги. Это обеспечит структурированную и предсказуемую реализацию.

---

### **Этап 1: Слой Базы Данных и Моделей**

На данном этапе изменения не требуются. Вся информация для кнопок меню (навыки, проекты, контакты) будет статичной или запрашиваться у LLM по аналогии с обычными сообщениями. Новые сущности в базе данных не создаются.

---

### **Этап 2: Слой UI (Команды, Клавиатуры и Конфигурация)**

На этом этапе мы определяем все визуальные и конфигурационные компоненты нового интерфейса.

#### **2.1. Определение UI Команд**
*   **Цель:** Определить стандартные команды, которые будут видны в меню Telegram (кнопка "Меню" слева от поля ввода).
*   **Файл:** `app/ui_commands.py` (новый файл).
*   **Логика:** Создать асинхронную функцию `set_ui_commands`, которая будет использовать `bot.set_my_commands()` для установки списка `BotCommand`. Команды: `/start` - Запустить бота, `/help` - Помощь.

#### **2.2. Создание Клавиатур**
*   **Цель:** Создать модуль для генерации `InlineKeyboardMarkup`.
*   **Файл:** `app/keyboards.py` (новый файл).
*   **Логика:**
    1.  Создать `CallbackData` для структурирования данных обратного вызова (например, `MainMenuCallback(action: str)`).
    2.  Создать функцию `get_main_keyboard`, которая возвращает `InlineKeyboardMarkup` с кнопками "Навыки", "Проекты", "Контакты". Каждая кнопка будет использовать `MainMenuCallback` для генерации `callback_data` (например, `main_menu:skills`).
    3.  Создать функцию `get_contact_keyboard` для генерации подменю с кнопками-ссылками на социальные сети и кнопкой "Назад".
    4.  Создать функцию `get_projects_keyboard` для генерации подменю с кнопкой для запроса информации о проекте, кнопками-ссылками на репозитории и кнопкой "Назад".

#### **2.3. Обновление Конфигурации**
*   **Цель:** Добавить путь к фотографии в файл конфигурации для гибкости.
*   **Файл:** `app/config.py` и `.env.example`.
*   **Логика:**
    1.  В класс `Settings` в `app/config.py` добавить новое поле `WELCOME_PHOTO_PATH: str | None = None`.
    2.  В файл `.env.example` добавить соответствующую переменную `WELCOME_PHOTO_PATH` с комментарием.

---

### **Этап 3: Слой Сервисной Логики (Обработчики)**

На этом этапе мы реализуем логику, которая будет реагировать на действия пользователя.

#### **3.1. Интеграция UI Команд**
*   **Цель:** Вызвать установку команд при старте бота.
*   **Файл:** `main.py`.
*   **Функция / Сигнатура:** `main()`.
*   **Логика:** В функции `main` перед запуском поллинга (`dp.start_polling(bot)`) добавить вызов `await set_ui_commands(bot)` и подключить роутер из `app/handlers/user_handlers.py` с помощью `dp.include_router()`.

#### **3.2. Обновление Приветственного Сообщения**
*   **Цель:** Модифицировать обработчик `/start` для отправки фото и клавиатуры.
*   **Файл:** `app/handlers/user_handlers.py`.
*   **Функция / Сигнатура:** `handle_start(message: Message, bot: Bot)`.
*   **Логика:**
    1.  Изменить логику отправки: вместо `message.answer()` использовать `message.answer_photo()`.
    2.  В `answer_photo` передать `photo=FSInputFile(settings.WELCOME_PHOTO_PATH)`, `caption=welcome_message` и `reply_markup=get_main_keyboard()`.
    3.  Добавить проверку, что если `WELCOME_PHOTO_PATH` не задан, отправляется обычное текстовое сообщение с клавиатурой.

#### **3.3. Создание Обработчиков для Кнопок**
*   **Цель:** Реализовать реакцию на нажатие inline-кнопок.
*   **Файл:** `app/handlers/user_handlers.py`.
*   **Логика:**
    1.  Вынести основную логику обработки запроса к LLM из `handle_message` в переиспользуемую функцию `process_query`.
    2.  Создать новый обработчик `handle_main_menu_button(query: CallbackQuery, callback_data: MainMenuCallback, bot: Bot)`.
    3.  Декорировать его с помощью `@router.callback_query(MainMenuCallback.filter())`.
    4.  Внутри обработчика реализовать `match-case` по `callback_data.action`:
        *   `skills`: Вызвать `process_query` с предопределенным вопросом о навыках.
        *   `projects`: Изменить сообщение (`query.message.edit_text`), отобразив подменю проектов с клавиатурой от `get_projects_keyboard`.
        *   `contact`: Изменить сообщение, отобразив подменю контактов с клавиатурой от `get_contact_keyboard`.
        *   `show_project_primenet`: Вызвать `process_query` с предопределенным вопросом о проекте PrimeNet.
        *   `back_to_main`: Изменить сообщение, вернув исходный текст приветствия и главную клавиатуру.

---

### **Этап 4: Тестирование**

*   **Цель:** Проверить корректность работы нового функционала.
*   **Логика:**
    1.  Запустить бота и убедиться, что в меню появились команды `/start` и `/help`.
    2.  Выполнить команду `/start` и проверить, что приходит сообщение с фото (если настроено) и inline-клавиатурой.
    3.  Нажать на каждую кнопку и убедиться в корректной реакции:
        *   "Навыки" -> ответ от LLM.
        *   "Проекты" -> открытие подменю.
        *   "Контакты" -> открытие подменю.
    4.  Проверить навигацию по подменю, включая кнопки-ссылки и кнопку "Назад".
    5.  Проверить, что основной функционал (ответы на произвольные текстовые вопросы) не нарушен.

---

## Описание для Pull Request

### feat: Implement Interactive Main Menu

**Краткое описание:**
Этот pull request вносит значительное улучшение в пользовательский опыт путем внедрения иерархического inline-меню. Он заменяет простое текстовое взаимодействие на структурированную, управляемую кнопками систему навигации. Реализация также включает в себя существенный архитектурный рефакторинг для повышения модульности и повторного использования кода.

**Ключевые изменения:**

*   **Интерактивное Inline-меню:**
    *   Главное меню с кнопками "Навыки", "Проекты" и "Контакты" теперь отображается по команде `/start`.
    *   Разделы "Проекты" и "Контакты" теперь открывают выделенные подменю с соответствующими ссылками и действиями, используя `message.edit_text` для плавного UX.

*   **Архитектурный рефакторинг:**
    *   Все обработчики, ориентированные на пользователя (`handle_start`, `handle_message`, `handle_main_menu_button`), были перенесены из `main.py` в новый, выделенный модуль: `app/handlers/user_handlers.py`.
    *   Основная логика RAG-цепочки была вынесена в переиспользуемую функцию `process_query`, что устранило дублирование кода между обработчиками текста и кнопок.

*   **Улучшения UI/UX:**
    *   Команда `/start` теперь отображает приветственное фото (если настроено) вместе с приветственным сообщением и новым меню.
    *   UI-команды (`/start`, `/help`) теперь установлены в меню бота.

**Как тестировать:**
1.  Запустить бота.
2.  Отправить команду `/start`.
3.  Убедиться, что приветственное сообщение, фото и inline-меню отображаются корректно.
4.  Протестировать навигацию по всем кнопкам меню и подменю:
    *   "Навыки" должны вызывать ответ от LLM.
    *   "Проекты" должны открывать подменю проектов. Протестировать как callback-кнопку, так и URL-ссылки.
    *   "Контакты" должны открывать подменю контактов. Протестировать URL-ссылки.
    *   Кнопка "Назад" должна корректно возвращать в главное меню.
5.  Убедиться, что прямые текстовые сообщения боту по-прежнему обрабатываются корректно.