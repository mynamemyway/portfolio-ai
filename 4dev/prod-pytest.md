*   **Автотесты:** Написать автотесты для проверки всей логики кроме внешних запросов к LLM.

### План разработки: Комплексное тестирование приложения

**Цель:** Интегрировать в проект фреймворк `pytest` и написать полный набор модульных и интеграционных тестов для проверки всей внутренней логики приложения, изолируя его от внешних зависимостей (LLM, Embedding Service).

---

**Этап 1: Настройка тестового окружения**
*   **Цель:** Установить и настроить фреймворк для тестирования.
*   **Действия:**
    1.  Добавить `pytest` и `pytest-asyncio` в `requirements.txt`.
    2.  Создать директорию `tests/` в корне проекта.
    3.  Создать пустой файл `__init__.py` в директории `tests/`.

---

**Этап 2: Тестирование модулей ядра (`app/core`)**

#### 2.1. Тестирование модуля статистики (`tests/test_stats.py`)
*   **Цель:** Проверить корректность записи данных в таблицу `query_stats`.
*   **Тесты:**
    *   `test_log_query_full`: Проверяет запись со всеми полями (имитация ответа LLM).
    *   `test_log_query_minimal`: Проверяет запись только с обязательными полями (имитация клика по кнопке).

#### 2.2. Тестирование модуля памяти (`tests/test_memory.py`)
*   **Цель:** Проверить все операции с историей чата в `SQLiteChatMessageHistory`.
*   **Тесты:**
    *   `test_add_and_retrieve_messages`: Проверяет добавление (одиночное и пакетное) и извлечение сообщений.
    *   `test_clear_history`: Проверяет, что `clear()` удаляет историю только для текущей сессии.
    *   `test_history_isolation`: Проверяет, что истории разных сессий не пересекаются.
    *   `test_non_ascii_characters`: Проверяет корректное сохранение кириллицы.

#### 2.3. Тестирование модуля RAG (`tests/test_rag.py`)
*   **Цель:** Проверить логику загрузки документов и работы кастомного клиента эмбеддингов.
*   **Тесты:**
    *   `test_load_and_split_documents`: Проверяет, что функция корректно находит, загружает и разбивает на чанки `.md` файлы из временной директории.
    *   `test_api_service_embeddings`: Проверяет кастомный класс `ApiServiceEmbeddings`, мокируя `httpx.AsyncClient` для имитации успешных и неуспешных ответов от API-сервиса эмбеддингов.

---

**Этап 3: Тестирование утилит и UI-компонентов**

#### 3.1. Тестирование форматеров текста (`tests/test_formatters.py`)
*   **Цель:** Проверить утилиту `sanitize_for_telegram_markdown`.
*   **Тесты:** Написать параметризованный тест, который проверяет корректное экранирование всех специальных символов `MarkdownV2` и правильную обработку различных комбинаций разметки.

#### 3.2. Тестирование генераторов клавиатур (`tests/test_keyboards.py`)
*   **Цель:** Убедиться, что все функции `get_*_keyboard` создают корректные объекты `InlineKeyboardMarkup`.
*   **Тесты:** Для каждой функции-генератора написать тест, который проверяет тип возвращаемого объекта и наличие ключевых кнопок с правильными `callback_data` или `url`.

#### 3.3. Тестирование установщика UI-команд (`tests/test_ui_commands.py`)
*   **Цель:** Проверить, что функция `set_ui_commands` вызывает правильный метод API бота.
*   **Тест:** Написать тест, который передает в `set_ui_commands` мок-объект `Bot` и проверяет, что метод `bot.set_my_commands` был вызван с корректным списком объектов `BotCommand`.

---

**Этап 4: Тестирование обработчиков (`app/handlers`)**

#### 4.1. Тестирование обработчиков команд (`tests/test_handlers.py`)
*   **Цель:** Проверить реакцию на команды `/start`, `/help`, `/reset`.
*   **Тесты:**
    *   `test_start_command`: Проверяет отправку приветственного сообщения, клавиатуры и запись в лог статистики.
    *   `test_reset_command`: Проверяет очистку истории чата, отправку подтверждения и запись в лог статистики.

#### 4.2. Тестирование обработчиков `callback`-кнопок (`tests/test_handlers.py`)
*   **Цель:** Проверить реакцию на нажатие `inline`-кнопок.
*   **Тесты:**
    *   `test_static_callback_handler`: Проверяет нажатие на статическую кнопку (например, "Projects"), корректное редактирование сообщения и запись в лог статистики.
    *   `test_rag_callback_handler`: Проверяет нажатие на кнопку, вызывающую RAG (например, "Skills"). Функция `process_query` (которая инкапсулирует RAG-цепочку) будет полностью замокана, чтобы тест проверял только факт ее вызова с правильным вопросом.

#### 4.3. Тестирование обработчика текстовых сообщений (`tests/test_handlers.py`)
*   **Цель:** Проверить основную логику обработки произвольного текста.
*   **Тест:** `test_text_message_handler` будет мокировать функцию `process_query` и проверять, что она корректно вызывается с текстом пользователя и другими необходимыми параметрами.
