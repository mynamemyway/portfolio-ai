*   **Автотесты:** Написать автотесты для проверки всей логики кроме внешних запросов к LLM.

### План разработки: Модуль автоматического тестирования

**Цель:** Интегрировать в проект фреймворк `pytest` и написать первый набор тестов для проверки корректности работы модуля сбора статистики. Это создаст основу для дальнейшего покрытия кода тестами.

---

**Этап 1: Настройка тестового окружения**
*   **Цель:** Установить и настроить фреймворк для тестирования.
*   **Действия:**
    1.  Добавить `pytest` и `pytest-asyncio` в файл зависимостей `requirements.txt`.
    2.  Создать директорию `tests/` в корне проекта для хранения всех тестов.
    3.  Создать пустой файл `__init__.py` в директории `tests/`

---

**Этап 2: Написание тестов для модуля `stats.py`**
*   **Цель:** Написать автотесты для функции `log_query`, проверяющие корректность записи данных в базу.
*   **Файл:** `tests/core/test_stats.py` (новый файл).
*   **Техническая логика:**
    1.  **Изоляция тестов:** Мы будем использовать `pytest fixture` для создания временной, изолированной базы данных SQLite в памяти для каждого теста. Это гарантирует, что тесты не влияют друг на друга и на основную рабочую базу данных.
    2.  **Тест полного логирования:** Будет написан асинхронный тест `test_log_query_full`, который вызывает `log_query` со всеми параметрами и проверяет корректность записи всех полей.
    3.  **Тест минимального логирования:** Будет написан асинхронный тест `test_log_query_minimal`, который вызывает `log_query` только с обязательными параметрами (имитируя клик) и проверяет, что опциональные поля записаны как `NULL`.

### План тестирования `app/core/memory.py`

**Цель:** Написать набор автотестов для класса `SQLiteChatMessageHistory`, чтобы убедиться в корректной работе всех операций с историей чата: добавление, извлечение и очистка сообщений.

**Техническая логика:**
Мы будем использовать тот же надежный подход, что и в `test_stats.py`, — создание временной файловой базы данных для каждого теста, чтобы гарантировать полную изоляцию.

1.  **Создание файла:** Создадим новый тестовый файл `tests/test_memory.py`.
2.  **Фикстура `isolated_db_path`:** Мы создадим аналогичную фикстуру, которая будет подменять путь к базе данных в модуле `app.core.memory` на путь к временному файлу.
3.  **Тесты:**
    *   **`test_add_and_retrieve_single_message`:** Проверит, что одно сообщение корректно добавляется и извлекается для конкретной сессии.
    *   **`test_add_and_retrieve_multiple_messages`:** Проверит, что пакетное добавление нескольких сообщений (`add_messages`) работает правильно.
    *   **`test_clear_history`:** Убедится, что метод `clear()` удаляет сообщения только для указанной сессии, не затрагивая другие.
    *   **`test_history_isolation_between_sessions`:** Ключевой тест, который проверит, что истории двух разных пользователей (`session_id`) в одной базе данных полностью изолированы друг от друга.
    *   **`test_non_ascii_characters`:** Проверит, что сообщения с кириллическими символами корректно сохраняются и извлекаются, подтверждая работу нашего исправления с `ensure_ascii=False`.
