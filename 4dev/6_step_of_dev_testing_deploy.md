# Шаг 6: Тестирование и Развертывание (Деплоймент)

**Цель:** Провести комплексное тестирование, подготовить проект к развертыванию и запустить его на облачной платформе Render.com.

---

### **Этап 1: Локальное интеграционное тестирование**
*   **Цель:** Убедиться, что все компоненты системы (aiogram, LangChain, RAG, память) корректно взаимодействуют друг с другом.
*   **Инструкции:**
    1.  **Запуск бота:** В терминале, с активированным виртуальным окружением, запустить бота командой `python main.py`.
    2.  **Тест команды `/start`:** Отправить боту команду `/start`. Ожидаемый результат: получение приветственного сообщения.
    3.  **Тест первого вопроса:** Задать боту вопрос, ответ на который есть в базе знаний. Ожидаемый результат: получение релевантного ответа, сгенерированного AI. Проверить, что в консоли нет ошибок, и что в файле `chat_history.sqlite3` появилась запись.
    4.  **Тест вопроса с контекстом:** Задать уточняющий вопрос, который опирается на предыдущий диалог (например, "Расскажи подробнее о последнем пункте"). Ожидаемый результат: AI должен понять контекст и дать релевантный ответ, используя историю из `chat_history.sqlite3`.
    5.  **Тест вопроса вне базы знаний:** Задать вопрос на отвлеченную тему. Ожидаемый результат: AI должен ответить, что не обладает информацией по данному вопросу, или дать общий ответ, не "галлюцинируя" фактами из базы знаний.

---

## Тестирование прототипа выполнено, бот работает, но результаты меня не устраивают из-за лимитов бесплатного API Mistral и неустранимых ошибок в логах бота.
Принято решение провести рефакторинг для перехода на одну из безлимитных моделей от open Router

### **Этап 2: Подготовка к развертыванию**
*   **Цель:** Подготовить артефакты проекта для развертывания на удаленном сервере.

#### **2.1. Финализация `requirements.txt`**
*   **Цель:** Убедиться, что файл зависимостей содержит все необходимые пакеты для production.
*   **Логика:**
    *   Проверить, что все используемые библиотеки (`aiogram`, `langchain`, `chromadb`, `pydantic-settings` и т.д.) присутствуют в `requirements.txt` с зафиксированными версиями.
    *   **Важно:** `chromadb` для работы на Linux может потребовать дополнительные системные зависимости. Render.com обычно справляется с этим автоматически, но это стоит иметь в виду.

#### **2.2. Обновление `README.md`**
*   **Цель:** Актуализировать документацию, чтобы она отражала финальное состояние проекта.
*   **Логика:**
    *   Обновить раздел "Инструкции по запуску", заменив `python -m app.main` на `python main.py`.
    *   Обновить статус-бар прогресса разработки до 100%.
    *   Отметить все пункты плана разработки как выполненные (`[x]`).

---

### **Этап 3: Развертывание на Render.com**
*   **Цель:** Настроить и запустить приложение в облачной среде Render.

#### **3.1. Создание сервиса**
*   **Инструкции:**
    1.  Войти в аккаунт Render.com и перейти в Dashboard.
    2.  Нажать "New +" и выбрать "Background Worker". Этот тип сервиса подходит для долгоживущих процессов, таких как Telegram-бот, которым не нужен публичный веб-адрес.
    3.  Подключить свой GitHub-репозиторий и выбрать проект `Portfolio-AI`.

#### **3.2. Настройка параметров сервиса**
*   **Инструкции:**
    1.  **Name:** Задать имя сервиса (например, `portfolio-ai-bot`).
    2.  **Region:** Выбрать регион (например, `Frankfurt`).
    3.  **Branch:** Выбрать основную ветку (`main` или `master`).
    4.  **Root Directory:** Оставить пустым, если `requirements.txt` находится в корне.
    5.  **Runtime:** Выбрать `Python 3`.
    6.  **Build Command:** `pip install -r requirements.txt`.
    7.  **Start Command:** `python main.py`.

#### **3.3. Настройка переменных окружения**
*   **Инструкции:**
    1.  Перейти в раздел "Environment".
    2.  Нажать "Add Environment Variable" и добавить ключи `BOT_TOKEN` и `MISTRAL_API_KEY` с их значениями из вашего локального `.env` файла.

#### **3.4. Первичная индексация и запуск**
*   **Цель:** Создать векторную базу знаний на сервере перед запуском бота.
*   **Инструкции:**
    1.  **Первый запуск:** После создания сервиса Render автоматически попытается его запустить. Этот запуск, скорее всего, завершится с ошибкой, так как база знаний еще не создана. Это нормально.
    2.  **Ручная индексация:** Перейти в раздел "Shell" вашего сервиса на Render. Выполнить команду `python -m app.core.rag`. Дождаться завершения процесса индексации.
    3.  **Перезапуск сервиса:** Перейти в раздел "Manual Deploy" и нажать "Deploy latest commit" или перезапустить сервис через меню "Restart service". После этого бот должен запуститься корректно, используя уже созданную базу знаний.


## Оптимизация веса пакета
Предлагаю следующий двухэтапный план, который полностью соответствует твоей идее об облегчении проекта:

1.  (Текущая задача): Устранение DeprecationWarning. Мы добавим langchain-chroma и обновим импорт Chroma. Это решит насущную проблему с предупреждением и станет первым шагом к модульности.

2. (Следующая задача): Замена оставшихся зависимостей. Мы проанализируем, какие еще компоненты используются из langchain-community (TextLoader, HuggingFaceEmbeddings), найдем для них специализированные пакеты (например, langchain-huggingface) и заменим импорты. После этого мы сможем полностью удалить langchain-community из requirements.txt, значительно уменьшив количество "лишнего" кода в зависимостях.